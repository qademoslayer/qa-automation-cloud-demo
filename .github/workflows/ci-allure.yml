name: Run Pytest + Allure + Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt
          # ç¡®ä¿æœ‰ allure pytest æ’ä»¶ï¼ˆå¦‚æœ requirements.txt æ²¡æœ‰ï¼‰
          pip install allure-pytest

      - name: Install Playwright browsers (chromium)
        run: |
          python -m pip install -U playwright
          python -m playwright install chromium

      - name: Clean old Allure outputs
        run: |
          rm -rf allure-results allure-report public

      # âœ… ä¸åå¤±è´¥ï¼Œä½†åç»­æ­¥éª¤ç»§ç»­æ‰§è¡Œï¼šcontinue-on-error
      - name: Run Pytest (generate allure-results)
        id: pytest
        continue-on-error: true
        run: |
          pytest -q --alluredir=allure-results

      - name: Install Allure CLI
        run: |
          wget -q https://github.com/allure-framework/allure2/releases/download/2.29.0/allure-2.29.0.tgz
          tar -xzf allure-2.29.0.tgz
          sudo mv allure-2.29.0 /opt/allure
          sudo ln -sf /opt/allure/bin/allure /usr/local/bin/allure
          allure --version

      - name: Generate Allure HTML (clean)
        if: always()
        run: |
          allure generate allure-results --clean -o allure-report

      # âœ… å…³é”®ï¼šå‘å¸ƒåˆ° /allure/latest/
      - name: Prepare Pages folder (public/allure/latest)
        if: always()
        run: |
          mkdir -p public/allure/latest
          cp -r allure-report/* public/allure/latest/

      - name: Upload report to GitHub Pages
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: test-artifacts
          if-no-files-found: ignore
          retention-days: 7

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          BRANCH: ${{ github.ref_name }}
          COMMIT: ${{ github.sha }}
          REPORT_URL: "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure/latest/"
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "SLACK_WEBHOOK_URL not set; skipping."
            exit 0
          fi

          # ç”¨ allure-results ç»Ÿè®¡ï¼ˆä¸å†è·‘ç¬¬äºŒæ¬¡ pytestï¼‰
          PASSED=$(grep -R "\"status\":\"passed\"" -h allure-results 2>/dev/null | wc -l || true)
          FAILED=$(grep -R "\"status\":\"failed\"" -h allure-results 2>/dev/null | wc -l || true)
          BROKEN=$(grep -R "\"status\":\"broken\"" -h allure-results 2>/dev/null | wc -l || true)
          SKIPPED=$(grep -R "\"status\":\"skipped\"" -h allure-results 2>/dev/null | wc -l || true)
          TOTAL=$((PASSED + FAILED + BROKEN + SKIPPED))

          if [ "$FAILED" -gt 0 ] || [ "$BROKEN" -gt 0 ]; then
            STATUS="FAILED"
            COLOR="#FF0000"
          else
            STATUS="SUCCESS"
            COLOR="#2EB886"
          fi

          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          TEXT="*QA Automation Pipeline â€” ${STATUS}*\n*Branch:* ${BRANCH}\n*Commit:* ${COMMIT}\n*Total:* ${TOTAL}\n*Passed:* ${PASSED}\n*Failed:* ${FAILED}\n*Broken:* ${BROKEN}\n*Skipped:* ${SKIPPED}\n\nğŸ“Š <${REPORT_URL}|View Allure Report (latest)>\nğŸ§¾ <${RUN_URL}|View GitHub Actions Run>"

          curl -X POST -H "Content-Type: application/json" \
            --data "{\"attachments\":[{\"color\":\"${COLOR}\",\"text\":\"${TEXT}\"}]}" \
            "$SLACK_WEBHOOK"

      # âœ… è®© job çœŸå®åæ˜  pytest æ˜¯å¦å¤±è´¥ï¼ˆå¦‚æœä½ è¦çº¢ç¯ï¼‰
      - name: Fail job if tests failed
        if: steps.pytest.outcome == 'failure'
        run: exit 1

  deploy:
    needs: tests
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
