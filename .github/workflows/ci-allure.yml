name: Run Pytest + Allure + Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt
          # Á°Æ‰øùÊúâ allure pytest Êèí‰ª∂ÔºàÂ¶ÇÊûú requirements.txt Ê≤°ÊúâÔºâ
          pip install allure-pytest

      - name: Install Playwright browsers (chromium)
        run: |
          python -m pip install -U playwright
          python -m playwright install chromium

      - name: Clean old Allure outputs
        run: |
          rm -rf allure-results allure-report public

      # ‚úÖ ‰∏çÂêûÂ§±Ë¥•Ôºå‰ΩÜÂêéÁª≠Ê≠•È™§ÁªßÁª≠ÊâßË°åÔºöcontinue-on-error
      - name: Run Pytest (generate allure-results)
        id: pytest
        continue-on-error: true
        run: |
          pytest -q --alluredir=allure-results

      - name: Install Allure CLI
        run: |
          wget -q https://github.com/allure-framework/allure2/releases/download/2.29.0/allure-2.29.0.tgz
          tar -xzf allure-2.29.0.tgz
          sudo mv allure-2.29.0 /opt/allure
          sudo ln -sf /opt/allure/bin/allure /usr/local/bin/allure
          allure --version

      - name: Generate Allure HTML (clean)
        if: always()
        run: |
          allure generate allure-results --clean -o allure-report

      - name: Sanity check allure report files
        if: always()
        run: |
          echo "index:"
          ls -la allure-report/index.html
          echo "data/test-cases count:"
          ls -1 allure-report/data/test-cases | wc -l

      - name: Prepare Pages folder (public/allure/latest)
        if: always()
        run: |
          mkdir -p public/allure/latest
          test -f allure-report/index.html
          cp -a allure-report/. public/allure/latest/

      - name: Create root index redirect to latest report
        if: always()
        run: |
          cat > public/index.html <<'EOF'
          <!doctype html>
          <html>
            <head>
              <meta charset="utf-8" />
              <meta http-equiv="refresh" content="0; url=./allure/latest/" />
              <title>Allure Report (latest)</title>
            </head>
            <body>
              <p>Redirecting to <a href="./allure/latest/">Allure latest report</a>...</p>
            </body>
          </html>
          EOF

      - name: Debug - list generated files
        if: always()
        run: |
          echo "=== allure-report ==="
          ls -la allure-report || true
          echo "=== public tree (first 200 lines) ==="
          find public -maxdepth 4 -type f | head -n 200 || true
          echo "=== check index ==="
          test -f public/allure/latest/index.html && echo "OK: latest index exists" || (echo "MISSING: public/allure/latest/index.html" && exit 2)
    
      - name: Add .nojekyll
        if: always()
        run: |
          touch public/.nojekyll

      - name: Upload report to GitHub Pages
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: test-artifacts
          if-no-files-found: ignore
          retention-days: 7

      - name: Compute Allure Stats
        if: always()
        run: |
          python - <<'PY'
          import json, glob, os
          from collections import Counter

          files = glob.glob("allure-results/*-result.json")
          c = Counter()
          for f in files:
            try:
              with open(f, "r", encoding="utf-8") as fh:
                data = json.load(fh)
              c[data.get("status", "unknown")] += 1
            except Exception:
              c["unknown"] += 1

          passed = c.get("passed", 0)
          failed = c.get("failed", 0)
          broken = c.get("broken", 0)
          skipped = c.get("skipped", 0)
          total = passed + failed + broken + skipped

          print("Allure result json files:", len(files))
          print("Counts => total=%d passed=%d failed=%d broken=%d skipped=%d" % (total, passed, failed, broken, skipped))

          # ÂÜôÂÖ• GITHUB_ENV ÁªôÂêéÁª≠ step Áî®
          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as env:
            env.write(f"TOTAL={total}\n")
            env.write(f"PASSED={passed}\n")
            env.write(f"FAILED={failed}\n")
            env.write(f"BROKEN={broken}\n")
            env.write(f"SKIPPED={skipped}\n")
          PY

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          BRANCH: ${{ github.ref_name }}
          COMMIT: ${{ github.sha }}
          REPORT_URL: "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure/latest/"
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "SLACK_WEBHOOK_URL not set; skipping."
            exit 0
          fi

          if [ "$FAILED" -gt 0 ] || [ "$BROKEN" -gt 0 ]; then
            STATUS="FAILED"
            COLOR="#FF0000"
          else
            STATUS="SUCCESS"
            COLOR="#2EB886"
          fi

          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          TEXT="*QA Automation Pipeline ‚Äî ${STATUS}*\n*Branch:* ${BRANCH}\n*Commit:* ${COMMIT}\n*Total:* ${TOTAL}\n*Passed:* ${PASSED}\n*Failed:* ${FAILED}\n*Broken:* ${BROKEN}\n*Skipped:* ${SKIPPED}\n\nüìä <${REPORT_URL}|View Allure Report (latest)>\nüßæ <${RUN_URL}|View GitHub Actions Run>"

          curl -X POST -H "Content-Type: application/json" \
            --data "{\"attachments\":[{\"color\":\"${COLOR}\",\"text\":\"${TEXT}\"}]}" \
            "$SLACK_WEBHOOK"

      # ‚úÖ ËÆ© job ÁúüÂÆûÂèçÊò† pytest ÊòØÂê¶Â§±Ë¥•ÔºàÂ¶ÇÊûú‰Ω†Ë¶ÅÁ∫¢ÁÅØÔºâ
      - name: Fail job if tests failed
        if: steps.pytest.outcome == 'failure'
        run: exit 1

  deploy:
    if: always()
    needs: tests
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

