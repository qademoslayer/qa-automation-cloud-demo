name: Run Pytest + Allure + Publish + Slack

on:
  push:
    branches: [ main ]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
    # ---------------------
    # 1. Checkout Source Code
    # ---------------------
    - name: Checkout code
      uses: actions/checkout@v4

    # ---------------------
    # 2. Setup Python
    # ---------------------
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    # ---------------------
    # 3. Install Dependencies
    # ---------------------
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        playwright install --with-deps chromium

    # ---------------------
    # 4. Run Tests
    # ---------------------
    - name: Run Pytest + Allure
      run: |
        pytest --alluredir=allure-results

    # ---------------------
    # 5. Upload Allure Results as Artifact
    # ---------------------
    - name: Upload Allure Results
      uses: actions/upload-artifact@v4
      with:
        name: allure-results
        path: allure-results

    # ---------------------
    # 6. Deploy Allure Report to GitHub Pages
    # ---------------------
    - name: Deploy Allure Report
      uses: simple-elf/allure-report-action@v1.6
      with:
        allure_results: allure-results
        report_folder: allure-report
        gh_pages: gh-pages

    # ---------------------
    # 7. Slack Notification (Enterprise Grade)
    # ---------------------
    - name: Slack Notify with Test Summary
      if: always()
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        BRANCH="${GITHUB_REF#refs/heads/}"
        COMMIT="${GITHUB_SHA::7}"
        REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

        TOTAL=$(pytest --collect-only 2>&1 | grep -o "collected [0-9]* items" | awk '{print $2}')
        PASSED=$(grep -R "\"status\":\"passed\"" -h allure-results 2>/dev/null | wc -l)
        FAILED=$(grep -R "\"status\":\"failed\"" -h allure-results 2>/dev/null | wc -l)

        STATUS="SUCCESS"
        COLOR="#2EB886"
        if [ "$FAILED" -gt 0 ]; then
          STATUS="FAILED"
          COLOR="#FF0000"
        fi

        # JSON PAYLOAD - literal block, indentation SAFE
        read -r -d '' PAYLOAD << 'EOF'
{
  "attachments": [
    {
      "color": "__COLOR__",
      "blocks": [
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "*QA Automation Pipeline â€” __STATUS__*\n*Branch:* __BRANCH__\n*Commit:* __COMMIT__\n*Total Tests:* __TOTAL__\n*Passed:* __PASSED__\n*Failed:* __FAILED__"
          }
        },
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "<__REPORT_URL__|ðŸ“Š View Allure Report>"
          }
        }
      ]
    }
  ]
}
EOF

        # Replace placeholders
        PAYLOAD="${PAYLOAD/__COLOR__/$COLOR}"
        PAYLOAD="${PAYLOAD/__STATUS__/$STATUS}"
        PAYLOAD="${PAYLOAD/__BRANCH__/$BRANCH}"
        PAYLOAD="${PAYLOAD/__COMMIT__/$COMMIT}"
        PAYLOAD="${PAYLOAD/__TOTAL__/$TOTAL}"
        PAYLOAD="${PAYLOAD/__PASSED__/$PASSED}"
        PAYLOAD="${PAYLOAD/__FAILED__/$FAILED}"
        PAYLOAD="${PAYLOAD/__REPORT_URL__/$REPORT_URL}"

        # Send
        curl -X POST -H "Content-Type: application/json" \
          --data "$PAYLOAD" \
          "$SLACK_WEBHOOK"
