name: QA Automation CI + Allure + Slack

on:
  push:
    branches: [ main ]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-playwright allure-pytest

      - name: Install Playwright Browsers
        run: playwright install --with-deps

      - name: Run tests
        run: pytest --alluredir=allure-results

      - name: Upload Allure results artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results

      - name: Deploy Allure Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-results
          publish_branch: gh-pages

      - name: Slack Notify (Stable Version)
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          STATUS="SUCCESS"
          if grep -R "\"status\":\"failed\"" allure-results >/dev/null 2>&1; then
            STATUS="FAILED"
          fi

          TOTAL=$(pytest --collect-only 2>&1 | grep -o "collected [0-9]* items" | awk '{print $2}')
          PASSED=$(grep -R "\"status\":\"passed\"" allure-results | wc -l)
          FAILED=$(grep -R "\"status\":\"failed\"" allure-results | wc -l)

          REPORT_URL="https://${GITHUB_ACTOR}.github.io/${GITHUB_REPOSITORY#*/}/"

          COLOR="#2eb886"
          if [ "$FAILED" -gt 0 ]; then COLOR="#ff0000"; fi

          PAYLOAD=$(cat <<EOF
{
  "attachments": [
    {
      "color": "$COLOR",
      "blocks": [
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "*QA Automation Pipeline â€” $STATUS*\n*Branch:* ${GITHUB_REF#refs/heads/}\n*Commit:* ${GITHUB_SHA::7}\n*Total Tests:* $TOTAL\n*Passed:* $PASSED\n*Failed:* $FAILED"
          }
        },
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "<$REPORT_URL|ðŸ“Š View Allure Report>"
          }
        }
      ]
    }
  ]
}
EOF
)

          curl -X POST -H 'Content-Type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK"
